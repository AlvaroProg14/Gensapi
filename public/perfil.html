<!--perfil.html-->
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/png" href="/img/icono.png">
    <title>Mi Perfil - GENSAPI</title>
    <link rel="stylesheet" href="/css/perfil_estilo.css">
</head>
<body>
    <header>
        <img src="/img/gensapi_logo.png" alt="Logo" id="logo">
        <nav>
            <ul>
                <li><a href="/index.html">Inicio</a></li>
                <li><a href="/Main.html">Personajes</a></li>
                <li><a href="/teambuild.html">Creador de Equipos</a></li>
                <li><a href="/equipos.html">Equipos</a></li>
                <li><a href="/sesion.html">Inicio de sesi√≥n</a></li>
            </ul>
        </nav>
        <h1>Mi Perfil</h1>
    </header>

    <div class="main-container">
        <!-- Loading state -->
        <div id="loading-state" class="loading-profile">
            <div class="loading-spinner"></div>
            <p>Cargando perfil...</p>
        </div>

        <!-- Profile content -->
        <div id="profile-content" class="profile-container" style="display: none;">
            <div class="profile-header">
                <div class="profile-avatar" id="user-avatar">
                    üë§
                </div>
                <h2 class="profile-name" id="user-name">Cargando...</h2>
                <p class="profile-email" id="user-email">cargando@email.com</p>
            </div>

            <div class="profile-content">
                <!-- Informaci√≥n b√°sica -->
                <div class="profile-section">
                    <h3>üìã Informaci√≥n de la Cuenta</h3>
                    <div class="profile-info">
                        <div class="info-row">
                            <span class="info-label">Nombre de Usuario:</span>
                            <span class="info-value" id="info-username">-</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Correo Electr√≥nico:</span>
                            <span class="info-value" id="info-email">-</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Miembro desde:</span>
                            <span class="info-value" id="info-member-since">-</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Estado:</span>
                            <span class="info-value" style="color: #2ed573; font-weight: 600;">‚úÖ Activo</span>
                        </div>
                    </div>
                </div>

                <!-- Estad√≠sticas -->
                <div class="profile-section">
                    <h3>üìä Estad√≠sticas</h3>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <span class="stat-number" id="teams-created">0</span>
                            <span class="stat-label">Equipos Creados</span>
                        </div>
                        <div class="stat-card">
                            <span class="stat-number" id="public-teams">0</span>
                            <span class="stat-label">Equipos P√∫blicos</span>
                        </div>
                        <div class="stat-card">
                            <span class="stat-number" id="total-likes">0</span>
                            <span class="stat-label">Likes Recibidos</span>
                        </div>
                        <div class="stat-card">
                            <span class="stat-number" id="days-active">0</span>
                            <span class="stat-label">D√≠as Activo</span>
                        </div>
                    </div>
                </div>

                <!-- Mejor Equipo -->
                <div class="profile-section" id="best-team-section" style="display: none;">
                    <h3>üèÜ Mejor Equipo</h3>
                    <div class="best-team-card" id="best-team-card">
                        <!-- Se llenar√° din√°micamente -->
                    </div>
                </div>

                <!-- Equipos del Usuario -->
                <div class="profile-section">
                    <h3>üõ†Ô∏è Mis Equipos</h3>
                    <div class="teams-section">
                        <div class="teams-header">
                            <select id="teams-filter">
                                <option value="all">Todos los equipos</option>
                                <option value="public">Solo p√∫blicos</option>
                                <option value="private">Solo privados</option>
                            </select>
                            <select id="teams-sort">
                                <option value="recent">M√°s recientes</option>
                                <option value="score">Mejor puntuaci√≥n</option>
                                <option value="likes">M√°s populares</option>
                            </select>
                        </div>
                        <div id="user-teams-container" class="user-teams-container">
                            <div class="loading-teams">Cargando equipos...</div>
                        </div>
                        <button id="load-more-teams" class="load-more-btn" style="display: none;">
                            Cargar m√°s equipos
                        </button>
                    </div>
                </div>

                <!-- Acciones -->
                <div class="action-buttons">
                    <a href="/teambuild.html" class="btn btn-primary">
                        üõ†Ô∏è Crear Equipo
                    </a>
                    <a href="/Main.html" class="btn btn-secondary">
                        üë• Ver Personajes
                    </a>
                    <button class="btn btn-danger" id="logout-btn">
                        üö™ Cerrar Sesi√≥n
                    </button>
                </div>
            </div>
        </div>

        <!-- Error state -->
        <div id="error-state" class="profile-container" style="display: none;">
            <div class="profile-content" style="text-align: center;">
                <h2>‚ö†Ô∏è Error</h2>
                <p>No se pudo cargar la informaci√≥n del perfil.</p>
                <div class="action-buttons">
                    <a href="/sesion.html" class="btn btn-primary">Iniciar Sesi√≥n</a>
                    <button class="btn btn-secondary" onclick="location.reload()">Reintentar</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Variables globales
        let currentUser = null;
        let userTeams = [];
        let currentPage = 1;
        let hasMoreTeams = true;

        // Elementos del DOM
        const loadingState = document.getElementById('loading-state');
        const profileContent = document.getElementById('profile-content');
        const errorState = document.getElementById('error-state');
        const logoutBtn = document.getElementById('logout-btn');

        // Funci√≥n para cargar datos del perfil
        async function loadProfile() {
            try {
                const token = localStorage.getItem('authToken');
                
                if (!token) {
                    throw new Error('No hay sesi√≥n activa');
                }

                // Cargar datos del usuario
                const userResponse = await fetch('/api/verify-token', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!userResponse.ok) {
                    throw new Error('Token inv√°lido');
                }

                const userResult = await userResponse.json();
                currentUser = userResult.user;
                
                // Cargar estad√≠sticas
                const statsResponse = await fetch('/api/users/stats', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                let stats = {};
                if (statsResponse.ok) {
                    stats = await statsResponse.json();
                }
                
                displayProfile(currentUser, stats);
                loadUserTeams();
                
            } catch (error) {
                console.error('Error cargando perfil:', error);
                showError();
            }
        }

        // Funci√≥n para mostrar el perfil
        function displayProfile(user, stats = {}) {
            // Ocultar loading y mostrar contenido
            loadingState.style.display = 'none';
            profileContent.style.display = 'block';
            
            // Actualizar informaci√≥n b√°sica
            const avatar = user.username.charAt(0).toUpperCase();
            document.getElementById('user-avatar').textContent = avatar;
            document.getElementById('user-name').textContent = user.username;
            document.getElementById('user-email').textContent = user.email;
            
            // Actualizar informaci√≥n detallada
            document.getElementById('info-username').textContent = user.username;
            document.getElementById('info-email').textContent = user.email;
            
            // Formatear fecha de creaci√≥n
            const createdDate = new Date(user.createdAt || Date.now());
            document.getElementById('info-member-since').textContent = 
                createdDate.toLocaleDateString('es-ES', { 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric' 
                });
            
            // Calcular d√≠as activo
            const daysSinceCreation = Math.floor((Date.now() - createdDate.getTime()) / (1000 * 60 * 60 * 24));
            document.getElementById('days-active').textContent = Math.max(1, daysSinceCreation);
            
            // Actualizar estad√≠sticas reales
            document.getElementById('teams-created').textContent = stats.totalTeams || 0;
            document.getElementById('public-teams').textContent = stats.publicTeams || 0;
            document.getElementById('total-likes').textContent = stats.totalLikes || 0;

            // Mostrar mejor equipo si existe
            if (stats.bestTeam) {
                displayBestTeam(stats.bestTeam);
            }
        }

        // Funci√≥n para mostrar el mejor equipo
        function displayBestTeam(bestTeam) {
            const bestTeamSection = document.getElementById('best-team-section');
            const bestTeamCard = document.getElementById('best-team-card');
            
            bestTeamCard.innerHTML = `
                <div class="best-team-info">
                    <h4>${bestTeam.name}</h4>
                    <div class="best-team-stats">
                        <span class="team-score">Puntuaci√≥n: ${bestTeam.synergy?.totalScore || 0}</span>
                        <span class="team-quality">${bestTeam.synergy?.quality || 'Sin evaluar'}</span>
                    </div>
                </div>
            `;
            
            bestTeamSection.style.display = 'block';
        }

        // Funci√≥n para cargar equipos del usuario
        async function loadUserTeams(reset = true) {
            try {
                if (reset) {
                    currentPage = 1;
                    userTeams = [];
                }

                const token = localStorage.getItem('authToken');
                const filter = document.getElementById('teams-filter')?.value || 'all';
                const sort = document.getElementById('teams-sort')?.value || 'recent';
                
                let url = `/api/teams/my?page=${currentPage}&limit=6`;
                
                const response = await fetch(url, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) {
                    throw new Error('Error cargando equipos');
                }

                const result = await response.json();
                
                if (reset) {
                    userTeams = result.teams;
                } else {
                    userTeams = [...userTeams, ...result.teams];
                }
                
                hasMoreTeams = currentPage < result.pagination.pages;
                displayUserTeams(userTeams, filter, sort);
                
                // Mostrar/ocultar bot√≥n de cargar m√°s
                const loadMoreBtn = document.getElementById('load-more-teams');
                if (loadMoreBtn) {
                    loadMoreBtn.style.display = hasMoreTeams ? 'block' : 'none';
                }

            } catch (error) {
                console.error('Error cargando equipos:', error);
                const container = document.getElementById('user-teams-container');
                if (container) {
                    container.innerHTML = '<p class="error-teams">Error cargando equipos</p>';
                }
            }
        }

        // Funci√≥n para mostrar equipos del usuario
        function displayUserTeams(teams, filter = 'all', sort = 'recent') {
            const container = document.getElementById('user-teams-container');
            
            if (!teams || teams.length === 0) {
                container.innerHTML = `
                    <div class="no-teams">
                        <p>No tienes equipos guardados a√∫n.</p>
                        <a href="/teambuild.html" class="btn btn-primary">Crear mi primer equipo</a>
                    </div>
                `;
                return;
            }

            // Filtrar equipos
            let filteredTeams = teams;
            if (filter === 'public') {
                filteredTeams = teams.filter(team => team.isPublic);
            } else if (filter === 'private') {
                filteredTeams = teams.filter(team => !team.isPublic);
            }

            // Ordenar equipos
            if (sort === 'score') {
                filteredTeams.sort((a, b) => (b.synergy?.totalScore || 0) - (a.synergy?.totalScore || 0));
            } else if (sort === 'likes') {
                filteredTeams.sort((a, b) => b.likes - a.likes);
            }

            if (filteredTeams.length === 0) {
                container.innerHTML = '<p class="no-teams">No hay equipos que coincidan con los filtros.</p>';
                return;
            }

            const teamsHtml = filteredTeams.map(team => createUserTeamCard(team)).join('');
            container.innerHTML = `<div class="teams-grid">${teamsHtml}</div>`;

            // Configurar event listeners
            setupTeamCardListeners();
        }

        // Funci√≥n para crear tarjeta de equipo del usuario
        function createUserTeamCard(team) {
            const charactersHtml = team.characters
                .sort((a, b) => a.slot - b.slot)
                .map(char => `
                    <div class="team-character">
                        <img src="${char.characterIcon}" alt="${char.characterName}" title="${char.characterName}">
                        <div class="character-element ${char.characterElement}"></div>
                    </div>
                `).join('');

            const createdDate = new Date(team.createdAt).toLocaleDateString('es-ES');

            return `
                <div class="user-team-card" data-team-id="${team._id}">
                    <div class="team-header">
                        <h4>${team.name}</h4>
                        <div class="team-visibility">
                            ${team.isPublic ? 'üåê' : 'üîí'}
                        </div>
                    </div>
                    
                    ${team.description ? `<p class="team-description">${team.description}</p>` : ''}
                    
                    <div class="team-characters-grid">
                        ${charactersHtml}
                    </div>
                    
                    <div class="team-stats">
                        <span class="team-score">Puntuaci√≥n: ${team.synergy?.totalScore || 0}</span>
                        <span class="team-likes">‚ù§Ô∏è ${team.likes}</span>
                    </div>
                    
                    <div class="team-meta">
                        <span class="team-date">Creado: ${createdDate}</span>
                        <span class="team-quality">${team.synergy?.quality || 'Sin evaluar'}</span>
                    </div>
                    
                    <div class="team-actions">
                        <button class="btn-edit-team" data-team-id="${team._id}">‚úèÔ∏è Editar</button>
                        <button class="btn-load-team" data-team-id="${team._id}">üì• Cargar</button>
                        <button class="btn-delete-team" data-team-id="${team._id}">üóëÔ∏è Eliminar</button>
                    </div>
                </div>
            `;
        }

        // Configurar event listeners para las tarjetas de equipos
        function setupTeamCardListeners() {
            // Botones de cargar equipo
            document.querySelectorAll('.btn-load-team').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const teamId = e.target.dataset.teamId;
                    window.open(`/teambuild.html?load=${teamId}`, '_blank');
                });
            });

            // Botones de eliminar equipo
            document.querySelectorAll('.btn-delete-team').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    const teamId = e.target.dataset.teamId;
                    if (confirm('¬øEst√°s seguro de que quieres eliminar este equipo?')) {
                        await deleteTeam(teamId);
                    }
                });
            });

            // Botones de editar (funcionalidad b√°sica)
            document.querySelectorAll('.btn-edit-team').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const teamId = e.target.dataset.teamId;
                    // Por ahora, redirigir al team builder
                    window.open(`/teambuild.html?load=${teamId}`, '_blank');
                });
            });
        }

        // Funci√≥n para eliminar un equipo
        async function deleteTeam(teamId) {
            try {
                const token = localStorage.getItem('authToken');
                const response = await fetch(`/api/teams/${teamId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    // Recargar equipos
                    loadUserTeams();
                    // Actualizar estad√≠sticas
                    loadProfile();
                } else {
                    const result = await response.json();
                    alert(result.error || 'Error eliminando el equipo');
                }

            } catch (error) {
                console.error('Error eliminando equipo:', error);
                alert('Error de conexi√≥n');
            }
        }

        // Funci√≥n para mostrar error
        function showError() {
            loadingState.style.display = 'none';
            errorState.style.display = 'block';
            
            // Limpiar localStorage si hay error
            localStorage.removeItem('authToken');
            localStorage.removeItem('currentUser');
        }

        // Funci√≥n para cerrar sesi√≥n
        function logout() {
            localStorage.removeItem('authToken');
            localStorage.removeItem('currentUser');
            
            // Redirigir a login
            window.location.href = '/sesion.html';
        }

        // Event listeners
        logoutBtn.addEventListener('click', logout);

        // Event listeners para filtros de equipos
        document.getElementById('teams-filter')?.addEventListener('change', () => {
            displayUserTeams(userTeams, document.getElementById('teams-filter').value, document.getElementById('teams-sort').value);
        });

        document.getElementById('teams-sort')?.addEventListener('change', () => {
            displayUserTeams(userTeams, document.getElementById('teams-filter').value, document.getElementById('teams-sort').value);
        });

        document.getElementById('load-more-teams')?.addEventListener('click', () => {
            currentPage++;
            loadUserTeams(false);
        });

        // Inicializar al cargar la p√°gina
        document.addEventListener('DOMContentLoaded', loadProfile);
    </script>

    <!-- Script del header din√°mico -->
    <script>
        // Aqu√≠ va el script del header din√°mico que te di antes
        async function updateHeaderAuth() {
            const authLink = document.querySelector('nav ul li:last-child a');
            
            if (!authLink) return;

            try {
                const token = localStorage.getItem('authToken');
                const userData = localStorage.getItem('currentUser');
                
                if (!token || !userData) {
                    authLink.textContent = 'Inicio de sesi√≥n';
                    authLink.href = '/sesion.html';
                    return;
                }

                const response = await fetch('/api/verify-token', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    const result = await response.json();
                    authLink.textContent = `üë§ ${result.user.username}`;
                    authLink.href = '/perfil.html';
                    authLink.classList.add('user-profile-link');
                } else {
                    localStorage.removeItem('authToken');
                    localStorage.removeItem('currentUser');
                    authLink.textContent = 'Inicio de sesi√≥n';
                    authLink.href = '/sesion.html';
                }

            } catch (error) {
                console.error('Error verificando autenticaci√≥n:', error);
                authLink.textContent = 'Inicio de sesi√≥n';
                authLink.href = '/sesion.html';
            }
        }

        // Inicializar header
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', updateHeaderAuth);
        } else {
            updateHeaderAuth();
        }
    </script>
</body>
</html>